# 第一章 FTP协议

## 1.1 FTP介绍

文件传输协议FTP（File Transfer Protocol 由 RFC 959 描述）。
FTP 工作在TCP/IP 协议族的**应用层**，其传输层使用的是 TCP 协议，它是基于客户机/服务器模式工作的。

## 1.2 FTP 支持的文件类型

* ASCII 码文件，这是 FTP 默认的文件类型。
* 图像（Image）文件，也称为二进制文件类型，发送的数据为连续的比特流，通常用于传输二进制。
* EBCDIC 码文件，它也是一种文本文件类型，用 8 位代码表示一个字符，该文件在传输时要求两端都使用 EBCDIC 码。
* 本地文件，字节的大小由本地主机定义，也就是说每一个字节的比特数由发送方规定。

## 1.3 FTP 文件的数据结构

* 文件结构，这是 FTP 默认的方式，文件被认为是一个连续的字节流，文件内部没有表示结构的信息。
* 记录结构，该结构只适用于文本文件（ASCII 码或者 EBCDIC 码文件）。记录结构文件是连续的记录构成的。
* 页结构，在 FTP 中，文件的一部分被称为页。当文件是由非连续的多个部分组成时，使用页结构，这种文件成为随机访问文件。每页都带有页号发送，以便收方能随机地存储各页。

## 1.4 文件的传输方式

* 流方式，这是支持文件传输的默认方式，文件以字节流的形式传输。
* 块方式，文件以一系列块来传输，每块前面都带有自己的头部。头部包含描述子代码域（8位）和计数域（16位），描述子代码域定义数据块的结束标志等内容，计数域说明了数据块的字节数。
* 压缩方式，用来对连续出现的相同字节进行压缩，现在已经很少使用。

## 1.5 工作原理

![工作原理图](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_principle.png?raw=true)

### 1.5.1 启动 FTP

在客户端，通过交互的用户界面，客户从终端上输入启动 FTP 的用户交互式命令。

### 1.5.2 建立控制连接

客户端 TCP 协议根据用户命令给出的服务器 IP 地址，向服务器提供 FTP 服务的 21 端口（该端口是 TCP 协议层传输 FTP 命令的端口）发出主动建立连接的请求。服务器收到请求后，通过 3 次握手，就在进行 FTP 命令处理的用户协议解析器进程和服务器协议解析器进程之间建立了一条 TCP 连接。

### 1.5.3 建立数据连接

当客户机通过交互式的用户界面，同 FTP 服务器发出要下载服务器上某一文件的命令时，该命令被送到用户协议解析器。

### 1.5.4 关闭 FTP

当客户机发出退出 FTP 的交互式命令时，控制连接被关闭，FTP 服务结束。

## 1.6 FTP 命令

|命令类型|命令|功能说明|
|:---:|:---:|:---:|
|访问控制命令|USER|服务器上的用户名|
|-|PASS|用户口令|
|-|CWD或XCWD|改变工作目录|
|-|CDUP或XCUP|回到上一层目录（父目录）|
|-|QUIT|退出|
|-|ACCT||
|-|SMNT||
|-|REIN||
|传输参数命令|PORT|数据端口，主要向服务器发送客户端数据连接的端口，格式为 PORT h1,h2,h3,h4,p1,p2，其中 32 位的 IP 地址用 h1,h2,h3.h4 表示，16 位的 TCP 端口号用 p1,p2 表示。|
|-|PASV|此命令要求服务器数据传输进程在随机端口上监听，进入被动接受请求的状态|
|-|TYPE|文件类型，可指定 ASCII 码，二进制等。|
|-|STRU|文件结构|
|-|MODE|传输模式|
|服务命令|RETR|获取文件|
|-|STOR|保存文件（上传文件），向服务器传输文件。如果已存在，则覆盖，否则，新建文件。|
|-|APPE|与STOR相似，文件已存在，则把数据附加到原文件尾部，否则，新建文件。|
|-|LIST|列出目录详细清单|
|-|NIST|列出名字列表|
|-|REST|重新开始，此命令后应该跟其他要求文件传输的 FTP 命令|
|-|ABOR|异常终止。如果先前操作已经完成，返回226，否则返回225。|
|-|PWD或XPWD|打印当前目录|
|-|MKD或XMKD|新建目录|
|-|RMD或XRMD|删除目录|
|-|DELE|删除文件|
|-|RNFR,RNTO|重命名|
|-|SITE CHMOD|修改权限|
|-|FEAT|服务器特性|
|-|SIZE|获得文件大小|
|-|STAT|返回服务器状态|
|-|NOOP|该命令不指定任何动作，只是要求服务器返回 OK 相应|
|-|HELP|帮助|

## 1.7 FTP 应答

### 1.7.1 FTP 应答格式

服务器通过控制连接发送给客户机的 FTP 应答，由 ASCII码形式的 3 位数字和一行文本提示信息组成，它们之间用一个空格分隔。

应答信息的每一行文本以回车`<CR>`和换行`<LF>`对结尾。如果需要产生一条多行的应答，每一行在 3 位数字应答代码之后包含一个连字符 ‘-’，而不是空格符；最后一行包含相同的 3 位数字应答代码，后跟一个空格符。

### 1.7.2 FTP 应答左右

