# 第一章 FTP协议

## 1.1 FTP介绍

文件传输协议FTP（File Transfer Protocol 由 RFC 959 描述）。
FTP 工作在TCP/IP 协议族的**应用层**，其传输层使用的是 TCP 协议，它是基于客户机/服务器模式工作的。

## 1.2 FTP 支持的文件类型

* ASCII 码文件，这是 FTP 默认的文件类型。
* 图像（Image）文件，也称为二进制文件类型，发送的数据为连续的比特流，通常用于传输二进制。
* EBCDIC 码文件，它也是一种文本文件类型，用 8 位代码表示一个字符，该文件在传输时要求两端都使用 EBCDIC 码。
* 本地文件，字节的大小由本地主机定义，也就是说每一个字节的比特数由发送方规定。

## 1.3 FTP 文件的数据结构

* 文件结构，这是 FTP 默认的方式，文件被认为是一个连续的字节流，文件内部没有表示结构的信息。
* 记录结构，该结构只适用于文本文件（ASCII 码或者 EBCDIC 码文件）。记录结构文件是连续的记录构成的。
* 页结构，在 FTP 中，文件的一部分被称为页。当文件是由非连续的多个部分组成时，使用页结构，这种文件成为随机访问文件。每页都带有页号发送，以便收方能随机地存储各页。

## 1.4 文件的传输方式

* 流方式，这是支持文件传输的默认方式，文件以字节流的形式传输。
* 块方式，文件以一系列块来传输，每块前面都带有自己的头部。头部包含描述子代码域（8位）和计数域（16位），描述子代码域定义数据块的结束标志等内容，计数域说明了数据块的字节数。
* 压缩方式，用来对连续出现的相同字节进行压缩，现在已经很少使用。

## 1.5 工作原理

![工作原理图](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_principle.png?raw=true)

### 1.5.1 启动 FTP

在客户端，通过交互的用户界面，客户从终端上输入启动 FTP 的用户交互式命令。

### 1.5.2 建立控制连接

客户端 TCP 协议根据用户命令给出的服务器 IP 地址，向服务器提供 FTP 服务的 21 端口（该端口是 TCP 协议层传输 FTP 命令的端口）发出主动建立连接的请求。服务器收到请求后，通过 3 次握手，就在进行 FTP 命令处理的用户协议解析器进程和服务器协议解析器进程之间建立了一条 TCP 连接。

### 1.5.3 建立数据连接

当客户机通过交互式的用户界面，同 FTP 服务器发出要下载服务器上某一文件的命令时，该命令被送到用户协议解析器。

### 1.5.4 关闭 FTP

当客户机发出退出 FTP 的交互式命令时，控制连接被关闭，FTP 服务结束。

## 1.6 FTP 命令

|命令类型|命令|功能说明|
|:---:|:---:|:---:|
|访问控制命令|USER `<username>`|服务器上的用户名|
|-|PASS|用户口令|
|-|CWD或XCWD|改变工作目录|
|-|CDUP或XCUP|回到上一层目录（父目录）|
|-|QUIT|退出|
|-|ACCT||
|-|SMNT||
|-|REIN||
|传输参数命令|PORT|数据端口，主要向服务器发送客户端数据连接的端口|
|-|PASV|此命令要求服务器数据传输进程在随机端口上监听，进入被动接受请求的状态|
|-|TYPE `<data type>`|文件类型（A=ASCII，E=EBCDIC，I=bibary）|
|-|STRU|文件结构|
|-|MODE|传输模式|
|服务命令|RETR|获取文件|
|-|STOR|保存文件（上传文件），向服务器传输文件。如果已存在，则覆盖，否则，新建文件。|
|-|APPE|与STOR相似，文件已存在，则把数据附加到原文件尾部，否则，新建文件。|
|-|LIST `<name>`|列出目录详细清单|
|-|NIST|列出名字列表|
|-|REST|重新开始，此命令后应该跟其他要求文件传输的 FTP 命令|
|-|ABOR|异常终止。如果先前操作已经完成，返回226，否则返回225。|
|-|PWD或XPWD|打印当前目录|
|-|MKD或XMKD|新建目录|
|-|RMD或XRMD|删除目录|
|-|DELE|删除文件|
|-|RNFR,RNTO|重命名|
|-|SITE CHMOD|修改权限|
|-|FEAT|服务器特性|
|-|SIZE|获得文件大小|
|-|STAT|返回服务器状态|
|-|NOOP|该命令不指定任何动作，只是要求服务器返回 OK 相应|
|-|HELP|帮助|
|-|SYST|返回服务器使用的操作系统|
|-|STOU|暂不实现|
|-|ALLO|暂不实现|
> 注：PORT 格式为 PORT h1,h2,h3,h4,p1,p2，其中 32 位的 IP 地址用 h1,h2,h3.h4 表示，16 位的 TCP 端口号用 p1,p2 表示。

## 1.7 FTP 应答

### 1.7.1 FTP 应答格式

服务器通过控制连接发送给客户机的 FTP 应答，由 ASCII码形式的 3 位数字和一行文本提示信息组成，它们之间用一个空格分隔。

应答信息的每一行文本以回车`<CR>`和换行`<LF>`对结尾。如果需要产生一条多行的应答，第一行在 3 位数字应答代码之后包含一个连字符 ‘-’，而不是空格符；最后一行包含相同的 3 位数字应答代码，后跟一个空格符。

### 1.7.2 FTP 应答作用

* 确保在文件传输过程中的请求和正在执行的动作保持一致。
* 保证用户程序总是可以得到服务器的状态信息，用户可以根据收到的状态信息对服务器是否正常执行了有关操作进行判定。

### 1.7.3 FTP 应答数字含义

第一位数字标识了响应是好，坏或者未完成。

|应答|说明|
|:---:|:---:|
|1yz|预备状态|
|2yz|完成状态|
|3yz|中间状态|
|4yz|暂时拒绝状态|
|5yz|永久拒绝状态|

第二位数响应发生了什么错误（比如，文件系统错误，语法错误）

|应答|说明|
|:---:|:---:|
|x0z|语法错误 - 给出的命令不存在、没有被实现或多余|
|x1z|信息错误 - 对于请求信息的响应，比如对状态或帮助的请求|
|x2z|连接错误 - 关于控制连接和数据连接的响应|
|x3z|身份验证和账户 - 对登录过程和账户处理的响应|
|x4z|未使用|
|x5z|文件系统 - 请求传输时服务器文件系统的状态等|

第三位为第二位数字更详细的说明

## 1.8 FTP两种工作模式

### 1.8.1 主动模式

![FTP主动连接工作模式](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_port_mode.png?raw=true)

![FTP主动模式工作过程](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_port_mode1.png?raw=true)

1. 客户端向服务器发送 PORT 命令
    * 客户端创建数据套接字；
    * 客户端绑定一个临时端口；
    * 客户端在套接字上监听；
    * 将 IP 与端口格式化为 h1,h2,h3,h4,p1,p2
2. 服务器以 200 响应
    * 服务器端解析客户端发过来的 IP 与端口，并暂存起来，以便后续建立数据连接。
3. 客户端向服务端发送 LIST
    * 服务器端检测在收到 LIST 命令之前是否接收过 PORT 或 PASV 命令。
    * 如果没有接受过，则响应 425 Use Port or PASV first。
    * 如果接收过，并且是 PORT，则服务器端创建数据套接字（bind 20 端口），调用 connect 主动连接客户端 IP 与端口，从而建立了数据连接。
4. 服务端发送 150 应答客户端，表示准备就绪，可以开始传输了。
5. 开始传输列表
6. 服务器发送 226 应答给客户端，表示数据传输结束。
    * 传输结束，服务器主动关闭数据套接字。

### 1.8.2 FTP 被动模式

![FTP被动连接工作模式](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_pasv_mode.png?raw=true)

![FTP被动模式工作过程](https://github.com/YaJunCui/notes/blob/master/images/ftp_work_pasv_mode1.png?raw=true)

1. 客户端向服务器发送 PASV 命令
2. 服务器以 227 响应
    * 服务器创建数据套接字；
    * 服务器绑定一个临时端口；
    * 服务器在套接字上监听；
    * 将 IP 与端口格式化为 h1,h2,h3,h4,p1,p2响应给客户端，以便客户端发起数据连接。
3. 客户端向服务端发送 LIST
    * 服务器端检测在收到 LIST 命令之前是否接收过 PORT 或 PASV 命令。
    * 如果没有接受过，则响应 425 Use Port or PASV first。
    * 如果接收过，并且是 PASV，则调用 accept 被动接受客户端的连接，返回已连接套接字，从而建立了数据连接。
4. 服务端发送 150 应答客户端，表示准备就绪，可以开始传输了。
5. 开始传输列表
6. 服务器发送 226 应答给客户端，表示数据传输结束。
    * 传输结束，服务器主动关闭数据套接字。

### 1.8.3 NAT 或防火墙对主被动模式的影响

#### 1.8.3.1 什么是 NAT

NAT的全称是 Network Address Translation，通过 NAT 可以将内网私有 IP 地址转换为公网 IP 地址。在一定程度上解决了公网地址不足的问题。

![NET](https://github.com/YaJunCui/notes/blob/master/images/ftp_net.png?raw=true)

#### 1.8.3.2 FTP 客户端处于 NAT 或者防火墙之后的主动模式

![FTP在NET之后的主动模式](https://github.com/YaJunCui/notes/blob/master/images/ftp_net_port_mode.png?raw=true)

1. 建立控制连接通道
    * 因为 NAT 会主动记录由内部发送外部的连接信息，而控制连接通道的建立是由客户端向服务端连接的，因此这一条连接可以顺利地建立起来。
2. 客户端与服务端数据连接建立时的通知
    * 客户端先启动 PORT BB 端口，并通过命令通道告知 FTP 服务器，且等待服务器的主动连接。
3. 服务器主动连接客户端
    * 由于通过 NAT 转换后，服务器只能得知 NAT 的地址并不知道客户端的 IP 地址，因此服务器会以 20 端口主动向 NAT 的 PORT BB 端口发送主动连接请求，但 NAT 并没有启用 PORT BB 端口，因此连接被拒绝。

#### 1.8.3.3 FTP 客户端处于 NAT 或者防火墙之后的被动模式

![FTP在NET之后的主动模式](https://github.com/YaJunCui/notes/blob/master/images/ftp_net_pasv_mode.png?raw=true)

#### 1.8.3.4 服务器处于 NAT 或者防火墙之后的被动模式

![服务器在NET之后的被动模式](https://github.com/YaJunCui/notes/blob/master/images/ftp_net_pasv_mode1.png?raw=true)